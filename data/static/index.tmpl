<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8">
    <title>使用者資訊 - SteveYi Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocas-ui/2.3.3/tocas.css">
</head>

<body>
    <div class="ts padded horizontally fitted fluid slate">
        <div class="ts very narrow container">
            <h1>使用者資訊</h1>
            <button class="ts negative right floated button" id="logoutBtn">登出</button>
            <button class="ts primary right floated button" id="refreshBtn">重新整理</button>
        </div>
    </div>
    <br>
    <div class="ts very narrow container">
        <div id="message"></div>
        <div class="ts segment" id="loader">
            <div class="ts placeholder">
                <div class="image header"></div>
                <div class="paragraph">
                    <div class="line"></div>
                    <div class="line"></div>
                    <div class="line"></div>
                </div>
            </div>
        </div>
        <div class="ts segment" id="userTableSegment" style="display:none;">
            <table class="ts celled table">
                <thead>
                    <tr>
                        <th>屬性</th>
                        <th>內容</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><i class="user icon"></i> Common Name (cn)</td>
                        <td id="cn"></td>
                    </tr>
                    <tr>
                        <td><i class="address card icon"></i> Distinguished Name (dn)</td>
                        <td id="dn"></td>
                    </tr>
                    <tr>
                        <td><i class="mail icon"></i> 電子郵件 (mail)</td>
                        <td id="mail"></td>
                    </tr>
                    <tr>
                        <td><i class="users icon"></i> 所屬群組 (memberOf)</td>
                        <td id="memberOf"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadUser() {
            document.getElementById('loader').style.display = 'block'
            document.getElementById('userTableSegment').style.display = 'none'
            document.getElementById('message').innerHTML = ''
            try {
                const res = await fetch('/api/v1/getuserinfo', { credentials: 'include' })
                if (res.status === 401) {
                    window.location.href = '/login'
                    return
                }
                if (!res.ok) throw new Error('伺服器錯誤')
                const data = await res.json()
                document.getElementById('cn').textContent = data.cn || ''
                document.getElementById('dn').textContent = data.dn || ''
                document.getElementById('mail').textContent = data.mail || '無'
                document.getElementById('memberOf').textContent = data.memberOf || '無'
                document.getElementById('userTableSegment').style.display = 'block'
            } catch (err) {
                document.getElementById('message').innerHTML =
                    `<div class="ts red message">載入失敗：${err.message}</div>`
            } finally {
                document.getElementById('loader').style.display = 'none'
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUser()
            document.getElementById('refreshBtn').addEventListener('click', loadUser)
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch('/api/v1/logout', { method: 'POST', credentials: 'include' })
                window.location.href = '/'
            })
        })
    </script>
</body>

</html>