<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8">
    <title>使用者資訊 - SteveYi Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocas-ui/2.3.3/tocas.css">
</head>

<body>
    <div class="ts padded horizontally fitted fluid slate">
        <div class="ts very narrow container">
            <h1>使用者資料</h1>
            <button class="ts negative right floated button" id="logoutBtn">登出</button>
            <button class="ts secondary right floated button" id="resetPwdBtn">重設密碼</button>
            <button class="ts primary right floated button" id="refreshBtn">重新整理</button>
        </div>
    </div>
    <br>
    <div class="ts very narrow container">
        <div id="message"></div>
        <div class="ts segment" id="loader">
            <div class="ts placeholder">
                <div class="image header"></div>
                <div class="paragraph">
                    <div class="line"></div>
                    <div class="line"></div>
                    <div class="line"></div>
                </div>
            </div>
        </div>
        <div class="ts segment" id="userTableSegment" style="display:none;">
            <table class="ts celled table">
                <thead>
                    <tr>
                        <th>屬性</th>
                        <th>內容</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>使用者名稱 (Username)</td>
                        <td id="username"></td>
                    </tr>
                    <tr>
                        <td>顯示名稱 (Display Name)</td>
                        <td id="displayName"></td>
                    </tr>
                    <tr>
                        <td>Distinguished Name</td>
                        <td id="distinguishedName"></td>
                    </tr>
                    <tr>
                        <td>電子郵件 (Email)</td>
                        <td id="email"></td>
                    </tr>
                    <tr>
                        <td>所屬群組 (Groups)</td>
                        <td id="groups"></td>
                    </tr>
                    <tr>
                        <td>最後登入 (Last Login)</td>
                        <td id="lastLogin"></td>
                    </tr>
                    <tr>
                        <td>建立時間 (Created At)</td>
                        <td id="createdAt"></td>
                    </tr>
                    <tr>
                        <td>MFA 狀態 (MFA Enabled)</td>
                        <td id="mfaEnabled"></td>
                    </tr>
                    <tr>
                        <td>密碼到期 (Password Expiry)</td>
                        <td id="passwordExpiry"></td>
                    </tr>
                    <tr>
                        <td>帳戶狀態 (Status)</td>
                        <td id="status"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadUser() {
            document.getElementById('loader').style.display = 'block'
            document.getElementById('userTableSegment').style.display = 'none'
            document.getElementById('message').innerHTML = ''
            try {
                const res = await fetch('/api/v1/getuserinfo/', { credentials: 'include' })
                if (res.status === 401) {
                    window.location.href = '/no-auth'
                    return
                }
                if (!res.ok) throw new Error('伺服器錯誤')
                const data = await res.json()
                document.getElementById('username').textContent = data.username || ''
                document.getElementById('displayName').textContent = data.displayName || ''
                document.getElementById('distinguishedName').textContent = data.distinguishedName || ''
                document.getElementById('email').textContent = data.email || '無'
                document.getElementById('groups').textContent = Array.isArray(data.groups) ? data.groups.join(', ') : (data.groups || '無')
                document.getElementById('lastLogin').textContent = data.lastLogin || '無'
                document.getElementById('createdAt').textContent = data.createdAt || '無'
                document.getElementById('mfaEnabled').textContent = data.mfaEnabled ? '已啟用' : '未啟用'
                document.getElementById('passwordExpiry').textContent = data.passwordExpiry || '無'
                document.getElementById('status').textContent = data.status || '未知'
                document.getElementById('userTableSegment').style.display = 'block'
            } catch (err) {
                document.getElementById('message').innerHTML =
                    `<div class="ts red message">載入失敗：${err.message}</div>`
            } finally {
                document.getElementById('loader').style.display = 'none'
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUser()
            document.getElementById('refreshBtn').addEventListener('click', loadUser)
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await fetch('/api/v1/logout', { method: 'POST', credentials: 'include' })
                window.location.href = '/no-auth'
            })
            document.getElementById('resetPwdBtn').addEventListener('click', () => {
                window.location.href = '/reset-password'
            })
        })
    </script>
</body>

</html>
